{"title":"","author":"jdotpz","content":"#New Elasticsearch Infrastructure for Our Logging\nThis week we went to a class on the [ELK stack](http://www.elasticsearch.org/overview/) (Elasticsearch, Logstash, and Kibana) to learn how to better scale and manage our logging service (which receives ~5 million logs per day).\n\nThe most obvious component to a better scaling logging infrastructure was to get our Elasticsearch setup sanely.  I'm putting notes for how I am doing that here.  (Note, this is currently in draft form)\n\n~~~~\n\n# This will be optiized to scale up to 5 servers\n# First, launch an server on Ubuntu 12.04\n* AMI ID ami-a49665cc\n* C3.4xlarge\n* 20gb EBS root volume\n* xvdb set as a 500gb 1000pIOPs blank volume\n* Security group that is appropriate...note which group this is for later\n* A role for EC2 read privileges (for the AWS auto-discovery plugin)\n\n# Install software\nwget -O - http://packages.elasticsearch.org/GPG-KEY-elasticsearch | sudo apt-key add -\n\necho \"deb http://packages.elasticsearch.org/elasticsearch/1.0/debian stable main\"  | sudo tee /etc/apt/sources.list.d/elasticsearch10.list\n\nsudo apt-get update\nsudo apt-get -y install openjdk-7-jre-headless elasticsearch=1.0.1\n\n# Install Elasticsearch-cloud-aws plugin for v1.0* of ES\ncd /usr/share/elasticsearch\nsudo bin/plugin -install elasticsearch/elasticsearch-cloud-aws/2.0.0\n\n# If you use marvel for monitoring ES, install that plugin too\nsudo  bin/plugin -install elasticsearch/marvel/latest\n\n# In /etc/elasticsearch/elasticsearch.yml uncomment and change the cluster name\ncluster.name: loggins\n\n# In the same file, /etc/elasticsearch/elasticsearch.yml uncomment and change the path.data\npath.data: /mnt/data\n\n# In teh same file, /etc/elasticsearch/elasticsearch.yml uncomment the mlockall option\nbootstrap.mlockall: true\n\n# In the same file, /etc/elasticsearch/elasticsearch.yml uncomment and change\ndiscovery.zen.ping.timeout: 10s\n\n\n# Make sure that the ES_MIN_MEM and ES_MAX_MEM\n\n# Add your auto-discovery settings to the bottomof the elasticsearch.yml file\n\ndiscovery.type: ec2\ndiscovery.ec2.groups: loggins-elasticsearch-ec2-sg\ndiscovery.zen.ping.multicast.enabled: false\ndiscovery.ec2.groups: loggins-elasticsearch-ec2-sg\n\n# In /etc/default/elasticsearch, uncomment and change\nES_HEAP_SIZE=16gb\n\n~~~\n# Set filesystem limits\n* Inside of /etc/security/limits.conf, put this at the bottom\nelasticsearch hard nofile 65535\nelasticsearch soft nofile 65535\nubuntu hard nofile 65535\nubuntu soft nofile 65535\n\n* Inside of /etc/pam.d/common-session, add the following line to the bottom\nsession required pam_limits.so\n\n* Open /etc/pam.d/su and ensure this line is uncommented:\nsession    required   pam_limits.so\n\n* Open /etc/pam.d/login and ensure this line is uncommented:\nsession    required   pam_limits.so\n\n\n# Setting up some fast disk for Elasticsearch to put data on\n* First, use the command:  sudo fdisk /dev/xvdb\nHit n for new\nHit p for primary\nHit enter for default first sector\nHit enter for default last sector\n\n* Your output should look like\nSelect (default p): p\nPartition number (1-4, default 1):\nUsing default value 1\nFirst sector (2048-1048575999, default 2048):\nUsing default value 2048\nLast sector, +sectors or +size{K,M,G} (2048-1048575999, default 1048575999):\nUsing default value 1048575999\n\n* Now hit w to write\nCommand (m for help): w\nThe partition table has been altered!\n\nCalling ioctl() to re-read partition table.\nSyncing disks.\n\n# Now, we'll make a new ext4 filesystem with that new disk\nsudo mkfs -t ext4 /dev/xvdb1\n\n# Now, lets make a mount point\nsudo mkdir /mnt/data\n\n# Now, lets be sure this gets mounted every time the server boots.\n**Add this to your /etc/fstab**\n/dev/xvdb1    /mnt/data   ext4    noatime     0        2\n\n# Now, mount up!\nsudo mount -a\n\n# We want that data dir owned by elasticsearch\nsudo chown -R elasticsearch:elasticsearch /mnt/data\n\n# Verify you have a new filesystem loaded in /mnt/data\ndf -h\nOutput:  /dev/xvdb1      493G  198M  467G   1% /mnt/data\n\n\n* Reboot!\nsudo shutdown -Fr now\n\n~~~\n","tags":["no tags yet"],"published":1402498716135,"updated":1402499046607}
